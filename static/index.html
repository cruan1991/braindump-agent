<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrainDump</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #1a1a1a;
      color: #e0e0e0;
      min-height: 100vh;
      padding: 2rem;
      line-height: 1.6;
      overflow-x: hidden;
    }
    
    .container { max-width: 600px; margin: 0 auto; position: relative; z-index: 1; }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    
    h1 { font-size: 1.5rem; font-weight: 500; color: #888; }
    
    .style-selector {
      display: flex;
      gap: 0.25rem;
      background: #2a2a2a;
      padding: 0.25rem;
      border-radius: 6px;
    }
    
    .style-btn {
      padding: 0.3rem 0.6rem;
      font-size: 0.75rem;
      border: none;
      background: transparent;
      color: #666;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.15s;
    }
    
    .style-btn:hover { color: #888; }
    .style-btn.active { background: #3a3a3a; color: #e0e0e0; }
    
    .input-area { margin-bottom: 2rem; }
    
    textarea {
      width: 100%;
      padding: 1rem;
      font-size: 1rem;
      font-family: inherit;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 8px;
      color: #e0e0e0;
      resize: vertical;
      min-height: 100px;
    }
    
    textarea:focus { outline: none; border-color: #4a9eff; }
    textarea::placeholder { color: #666; }
    
    .input-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; }
    
    button {
      padding: 0.6rem 1.2rem;
      font-size: 0.9rem;
      font-family: inherit;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .btn-primary { background: #4a9eff; color: #fff; }
    .btn-primary:hover { background: #3a8eef; }
    .btn-primary:disabled { background: #3a3a3a; color: #666; cursor: not-allowed; }
    
    .btn-mic {
      background: #2a2a2a;
      color: #888;
      border: 1px solid #3a3a3a;
      font-size: 1.2rem;
      padding: 0.6rem 0.8rem;
    }
    .btn-mic:hover { background: #3a3a3a; }
    .btn-mic.recording { background: #ff4a4a; color: #fff; border-color: #ff4a4a; }
    .btn-mic:disabled { opacity: 0.3; cursor: not-allowed; }
    
    .aftercare, .confirm-box, .congrats-box, .clear-all-box {
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 2rem;
      display: none;
      animation: fadeIn 0.3s;
    }
    .aftercare.show, .confirm-box.show, .congrats-box.show, .clear-all-box.show { display: block; }
    
    .aftercare { background: #2d3a2d; }
    .confirm-box { background: #3a3a2d; }
    .clear-all-box { background: #2d3a4a; text-align: center; padding: 1.5rem; }
    
    .clear-all-title { font-size: 1.1rem; color: #80c0ff; margin-bottom: 0.5rem; }
    .clear-all-count { color: #aaa; margin-bottom: 0.5rem; }
    .clear-all-detail { color: #888; font-size: 0.85rem; margin-bottom: 1rem; }
    .clear-all-detail .parking-note { color: #ffd93d; }
    .btn-clear-all { 
      background: linear-gradient(135deg, #4a9eff, #8a6eff); 
      color: #fff; 
      font-size: 1rem;
      padding: 0.75rem 2rem;
    }
    .btn-clear-all:hover { opacity: 0.9; }
    .btn-cancel-clear { background: #3a3a3a; color: #888; margin-left: 0.5rem; }
    
    .congrats-box { 
      background: linear-gradient(135deg, #2d4a3d, #3a4a2d);
      text-align: center;
      padding: 2rem;
      position: relative;
      overflow: hidden;
    }
    
    .confirm-question { color: #e0d080; margin-bottom: 0.75rem; }
    .confirm-actions { display: flex; gap: 0.5rem; }
    .btn-yes { background: #4a9eff; color: #fff; font-size: 0.85rem; padding: 0.5rem 1rem; }
    .btn-no { background: #3a3a3a; color: #888; font-size: 0.85rem; padding: 0.5rem 1rem; }
    .btn-no:hover { background: #4a4a4a; }
    
    .aftercare-praise { color: #8fdf8f; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .aftercare-hint { color: #e0d080; font-size: 0.9rem; margin-bottom: 0.5rem; }
    .aftercare-safety { color: #888; font-size: 0.85rem; margin-bottom: 1rem; }
    .aftercare-ask { color: #ccc; margin-bottom: 0.75rem; }
    
    .aftercare-micro {
      background: #3a4a3a;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    .micro-title { font-weight: 500; margin-bottom: 0.25rem; }
    .micro-steps { font-size: 0.85rem; color: #aaa; }
    .micro-eta { font-size: 0.75rem; color: #666; margin-top: 0.25rem; }
    
    .aftercare-actions { display: flex; gap: 0.5rem; }
    .btn-accept { background: #4a9eff; color: #fff; font-size: 0.85rem; padding: 0.5rem 1rem; }
    .btn-decline { background: #3a3a3a; color: #888; font-size: 0.85rem; padding: 0.5rem 1rem; }
    .btn-decline:hover { background: #4a4a4a; }
    
    .congrats-emoji { font-size: 4rem; margin-bottom: 1rem; }
    .congrats-title { font-size: 1.8rem; color: #8fdf8f; margin-bottom: 0.5rem; }
    .congrats-sub { color: #ccc; font-size: 1.1rem; }
    .btn-close-congrats { margin-top: 1.5rem; background: #3a3a3a; color: #ccc; }
    
    .firework {
      position: fixed;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: firework 1s ease-out forwards;
      pointer-events: none;
      z-index: 1000;
    }
    
    @keyframes firework {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(0); opacity: 0; }
    }
    
    .particle {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: particle 1.5s ease-out forwards;
      pointer-events: none;
      z-index: 1000;
    }
    
    @keyframes particle {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(0) translateY(100px); }
    }
    
    .recommend-box {
      background: #3a3a4a;
      padding: 0.75rem;
      border-radius: 6px;
      margin-top: 0.75rem;
    }
    .recommend-title { font-size: 0.85rem; color: #aaa; margin-bottom: 0.5rem; }
    .recommend-task { color: #e0e0e0; }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section { margin-bottom: 2rem; }
    .section-title {
      font-size: 0.85rem;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.75rem;
    }
    
    .task-list { list-style: none; }
    .task-item {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 1rem;
    }
    .task-content { flex: 1; }
    .task-name { font-weight: 500; margin-bottom: 0.25rem; }
    .task-hint { font-size: 0.85rem; color: #888; }
    .btn-done {
      background: #3a3a3a;
      color: #888;
      font-size: 0.8rem;
      padding: 0.4rem 0.8rem;
      flex-shrink: 0;
    }
    .btn-done:hover { background: #4a4a4a; color: #fff; }
    
    .parking-item {
      background: #252525;
      border-radius: 6px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
    }
    .parking-content { flex: 1; }
    .parking-name { font-size: 0.9rem; }
    .parking-reason { color: #666; font-size: 0.8rem; }
    .btn-parking-done {
      background: #333;
      color: #666;
      font-size: 0.75rem;
      padding: 0.3rem 0.6rem;
      flex-shrink: 0;
    }
    .btn-parking-done:hover { background: #444; color: #aaa; }
    
    .done-toggle {
      background: none;
      border: none;
      color: #666;
      font-size: 0.85rem;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .done-toggle:hover { color: #888; }
    .done-list { display: none; margin-top: 0.75rem; }
    .done-list.show { display: block; }
    .done-item { font-size: 0.85rem; color: #666; padding: 0.25rem 0; }
    .done-date { color: #555; margin-right: 0.5rem; }
    
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: #2a2a2a;
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
    }
    .modal h3 { font-size: 1rem; font-weight: 500; margin-bottom: 1rem; }
    .modal textarea { min-height: 80px; margin-bottom: 1rem; }
    .modal-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
    .btn-cancel { background: #3a3a3a; color: #888; }
    .btn-cancel:hover { background: #4a4a4a; }
    .empty { color: #555; font-size: 0.9rem; padding: 1rem 0; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>BrainDump</h1>
      <div class="style-selector">
        <button class="style-btn" data-style="snarky">Snarky</button>
        <button class="style-btn" data-style="neutral">Neutral</button>
        <button class="style-btn" data-style="warm">Warm</button>
      </div>
    </header>
    
    <div class="input-area">
      <textarea id="input" placeholder="Type anything...&#10;Tasks, thoughts, worries, ideas"></textarea>
      <div class="input-actions">
        <button class="btn-mic" id="micBtn" title="Voice input">üé§</button>
        <button class="btn-primary" id="replanBtn">Replan</button>
      </div>
    </div>
    
    <div class="clear-all-box" id="clearAllBox">
      <div class="clear-all-title" id="clearAllTitle">üéØ Clear all?</div>
      <div class="clear-all-count" id="clearAllCount">X tasks total</div>
      <div class="clear-all-detail" id="clearAllDetail"></div>
      <button class="btn-clear-all" id="clearAllBtn">‚ú® All Done!</button>
      <button class="btn-cancel-clear" id="cancelClearBtn">Cancel</button>
    </div>
    
    <div class="confirm-box" id="confirmBox">
      <div class="confirm-question" id="confirmQuestion">Did you complete XXX?</div>
      <div class="confirm-actions">
        <button class="btn-yes" id="confirmYes">Yes, done!</button>
        <button class="btn-no" id="confirmNo">Not yet</button>
      </div>
    </div>
    
    <div class="congrats-box" id="congratsBox">
      <div class="congrats-emoji">üéâ</div>
      <div class="congrats-title" id="congratsTitle">Awesome!</div>
      <div class="congrats-sub" id="congratsSub">All tasks completed today!</div>
      <button class="btn-close-congrats" id="closeCongrats">Close</button>
    </div>
    
    <div class="aftercare" id="aftercare">
      <div class="aftercare-praise" id="aftercarePraise"></div>
      <div class="aftercare-hint" id="aftercareHint" style="display:none;"></div>
      <div class="aftercare-safety" id="aftercareSafety"></div>
      <div id="recommendBox" class="recommend-box" style="display:none;">
        <div class="recommend-title">Main tasks done. Want to continue?</div>
        <div class="recommend-task" id="recommendTask"></div>
      </div>
      <div id="microSection" style="display:none;">
        <div class="aftercare-ask" id="aftercareAsk"></div>
        <div class="aftercare-micro" id="aftercareMicro">
          <div class="micro-title" id="microTitle"></div>
          <div class="micro-steps" id="microSteps"></div>
          <div class="micro-eta" id="microEta"></div>
        </div>
        <div class="aftercare-actions">
          <button class="btn-accept" id="acceptBtn">Do it</button>
          <button class="btn-decline" id="declineBtn">No thanks</button>
        </div>
      </div>
    </div>
    
    <div class="section" id="todaySection">
      <div class="section-title">Today's Tasks</div>
      <ul class="task-list" id="todayList"></ul>
    </div>
    
    <div class="section" id="parkingSection">
      <div class="section-title">Can Skip Today</div>
      <div id="parkingList"></div>
    </div>
    
    <div class="section">
      <button class="done-toggle" id="doneToggle">
        <span>‚ñ∂</span> Completed (<span id="doneCount">0</span>)
      </button>
      <div class="done-list" id="doneList"></div>
    </div>
  </div>
  
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <h3>Done: <span id="modalTask"></span></h3>
      <textarea id="noteInput" placeholder="Any thoughts? (optional)"></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" id="cancelBtn">Cancel</button>
        <button class="btn-primary" id="confirmBtn">Complete</button>
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="parkingModal">
    <div class="modal">
      <h3>Done: <span id="parkingModalTask"></span></h3>
      <textarea id="parkingNoteInput" placeholder="Any thoughts? (optional)"></textarea>
      <div class="modal-actions">
        <button class="btn-cancel" id="parkingCancelBtn">Cancel</button>
        <button class="btn-primary" id="parkingConfirmBtn">Complete</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    
    let currentTask = null;
    let currentParkingTask = null;
    let currentMicroAction = null;
    let currentStyle = 'neutral';
    let pendingConfirmItems = [];
    let currentConfirmIndex = 0;
    let pendingClearAllTasks = [];
    let pendingClearAllParking = [];
    
    function createFireworks() {
      const colors = ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#ff6fff', '#6bfff6'];
      const count = 50;
      
      for (let i = 0; i < count; i++) {
        setTimeout(() => {
          const particle = document.createElement('div');
          particle.className = 'particle';
          particle.style.left = Math.random() * window.innerWidth + 'px';
          particle.style.top = Math.random() * window.innerHeight * 0.6 + 'px';
          particle.style.background = colors[Math.floor(Math.random() * colors.length)];
          particle.style.transform = `scale(${Math.random() * 0.5 + 0.5})`;
          document.body.appendChild(particle);
          
          setTimeout(() => particle.remove(), 1500);
        }, i * 30);
      }
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isRecording = false;
    
    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      recognition.onresult = (e) => {
        const text = e.results[0][0].transcript;
        $('#input').value += (($('#input').value ? ' ' : '') + text);
        stopRecording();
      };
      recognition.onerror = () => stopRecording();
      recognition.onend = () => stopRecording();
    } else {
      $('#micBtn').disabled = true;
    }
    
    function startRecording() {
      if (!recognition) return;
      recognition.start();
      isRecording = true;
      $('#micBtn').classList.add('recording');
    }
    
    function stopRecording() {
      if (!recognition) return;
      try { recognition.stop(); } catch(e) {}
      isRecording = false;
      $('#micBtn').classList.remove('recording');
    }
    
    $('#micBtn').onclick = () => isRecording ? stopRecording() : startRecording();
    
    async function api(endpoint, method = 'GET', body = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(endpoint, opts);
      return res.json();
    }
    
    function updateStyleUI(style) {
      currentStyle = style;
      $$('.style-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.style === style));
    }
    
    $$('.style-btn').forEach(btn => {
      btn.onclick = async () => {
        await api('/api/style', 'POST', { praise_style: btn.dataset.style });
        updateStyleUI(btn.dataset.style);
      };
    });
    
    function render(state) {
      const todayList = $('#todayList');
      if (state.today.length === 0) {
        todayList.innerHTML = '<div class="empty">No tasks</div>';
      } else {
        todayList.innerHTML = state.today.map(t => `
          <li class="task-item">
            <div class="task-content">
              <div class="task-name">${escapeHtml(t.name)}</div>
              ${t.hint ? `<div class="task-hint">‚Üí ${escapeHtml(t.hint)}</div>` : ''}
            </div>
            <button class="btn-done" data-task="${escapeHtml(t.name)}">Done</button>
          </li>
        `).join('');
      }
      
      if (state.parking.length === 0) {
        $('#parkingSection').style.display = 'none';
      } else {
        $('#parkingSection').style.display = 'block';
        $('#parkingList').innerHTML = state.parking.map(p => `
          <div class="parking-item">
            <div class="parking-content">
              <div class="parking-name">${escapeHtml(p.name)}</div>
              <div class="parking-reason">‚Äî ${escapeHtml(p.reason)}</div>
            </div>
            <button class="btn-parking-done" data-task="${escapeHtml(p.name)}">Done</button>
          </div>
        `).join('');
      }
      
      $('#doneCount').textContent = state.done.length;
      if (state.done.length === 0) {
        $('#doneList').innerHTML = '<div class="empty">Nothing completed yet</div>';
      } else {
        $('#doneList').innerHTML = state.done.map(d => `
          <div class="done-item">${d.date ? `<span class="done-date">${d.date}</span>` : ''}${escapeHtml(d.text)}</div>
        `).join('');
      }
      
      $$('.btn-done').forEach(btn => btn.onclick = () => openModal(btn.dataset.task));
      $$('.btn-parking-done').forEach(btn => btn.onclick = () => openParkingModal(btn.dataset.task));
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function showClearAllBox(tasks, parkingTasks = null) {
      pendingClearAllTasks = tasks;
      pendingClearAllParking = parkingTasks || [];
      
      const totalCount = tasks.length + pendingClearAllParking.length;
      
      if (pendingClearAllParking.length > 0) {
        $('#clearAllTitle').textContent = 'üöÄ Clear everything!';
        $('#clearAllCount').textContent = `${totalCount} tasks total`;
        $('#clearAllDetail').innerHTML = `
          <div>üìã Main tasks: ${tasks.length}</div>
          <div class="parking-note">‚≠ê Optional: ${pendingClearAllParking.length}</div>
        `;
        $('#clearAllBtn').textContent = 'üéÜ All All Done!';
      } else {
        $('#clearAllTitle').textContent = 'üéØ Clear all?';
        $('#clearAllCount').textContent = `${tasks.length} tasks`;
        $('#clearAllDetail').innerHTML = '';
        $('#clearAllBtn').textContent = '‚ú® All Done!';
      }
      
      $('#clearAllBox').classList.add('show');
    }
    
    function hideClearAllBox() {
      $('#clearAllBox').classList.remove('show');
      pendingClearAllTasks = [];
      pendingClearAllParking = [];
    }
    
    $('#clearAllBtn').onclick = async () => {
      if (pendingClearAllTasks.length === 0 && pendingClearAllParking.length === 0) return;
      
      $('#clearAllBtn').disabled = true;
      $('#clearAllBtn').textContent = 'Processing...';
      
      const body = { tasks: pendingClearAllTasks };
      if (pendingClearAllParking.length > 0) {
        body.parking_tasks = pendingClearAllParking;
      }
      
      const res = await api('/api/complete_all', 'POST', body);
      
      hideClearAllBox();
      render(res.state);
      
      createFireworks();
      setTimeout(createFireworks, 300);
      setTimeout(createFireworks, 600);
      if (res.include_parking) {
        setTimeout(createFireworks, 900);
        setTimeout(createFireworks, 1200);
      }
      
      showCongrats(res.praise, res.completed_count);
      
      $('#clearAllBtn').disabled = false;
      $('#clearAllBtn').textContent = '‚ú® All Done!';
    };
    
    $('#cancelClearBtn').onclick = hideClearAllBox;
    
    function showConfirmBox(items) {
      pendingConfirmItems = items;
      currentConfirmIndex = 0;
      showNextConfirm();
    }
    
    function showNextConfirm() {
      if (currentConfirmIndex >= pendingConfirmItems.length) {
        hideConfirmBox();
        return;
      }
      const item = pendingConfirmItems[currentConfirmIndex];
      $('#confirmQuestion').textContent = `Did you complete "${item}"?`;
      $('#confirmBox').classList.add('show');
    }
    
    function hideConfirmBox() {
      $('#confirmBox').classList.remove('show');
      pendingConfirmItems = [];
      currentConfirmIndex = 0;
    }
    
    $('#confirmYes').onclick = async () => {
      const item = pendingConfirmItems[currentConfirmIndex];
      $('#confirmYes').disabled = true;
      $('#confirmYes').textContent = '...';
      
      const res = await api('/api/confirm_done', 'POST', { item });
      render(res.state);
      
      if (res.all_done) {
        hideConfirmBox();
        createFireworks();
        showCongrats(res.praise, pendingConfirmItems.length);
      } else {
        showAftercare(res);
      }
      
      $('#confirmYes').disabled = false;
      $('#confirmYes').textContent = 'Yes, done!';
      
      currentConfirmIndex++;
      if (currentConfirmIndex < pendingConfirmItems.length && !res.all_done) {
        setTimeout(showNextConfirm, 500);
      } else {
        hideConfirmBox();
      }
    };
    
    $('#confirmNo').onclick = () => {
      currentConfirmIndex++;
      showNextConfirm();
    };
    
    function showCongrats(title, count) {
      $('#congratsTitle').textContent = title || 'Awesome!';
      $('#congratsSub').textContent = count ? `Completed ${count} tasks!` : 'All tasks done today!';
      $('#congratsBox').classList.add('show');
    }
    
    $('#closeCongrats').onclick = () => {
      $('#congratsBox').classList.remove('show');
    };
    
    function showAftercare(data) {
      if (data.all_done) {
        createFireworks();
        showCongrats(data.praise);
        return;
      }
      
      $('#aftercarePraise').textContent = data.praise || '';
      
      if (data.hint) {
        $('#aftercareHint').textContent = data.hint;
        $('#aftercareHint').style.display = 'block';
      } else {
        $('#aftercareHint').style.display = 'none';
      }
      
      $('#aftercareSafety').textContent = data.safety_note || '';
      
      if (data.recommend_to_today) {
        $('#recommendTask').textContent = data.recommend_to_today.name;
        $('#recommendBox').style.display = 'block';
      } else {
        $('#recommendBox').style.display = 'none';
      }
      
      if (data.micro_action && data.ask) {
        currentMicroAction = data.micro_action;
        $('#aftercareAsk').textContent = data.ask;
        $('#microTitle').textContent = data.micro_action.title;
        $('#microSteps').textContent = data.micro_action.steps;
        $('#microEta').textContent = `~${data.micro_action.eta_seconds} sec`;
        $('#microSection').style.display = 'block';
      } else {
        $('#microSection').style.display = 'none';
        currentMicroAction = null;
      }
      
      $('#aftercare').classList.add('show');
    }
    
    function hideAftercare() {
      $('#aftercare').classList.remove('show');
      currentMicroAction = null;
    }
    
    $('#acceptBtn').onclick = async () => {
      if (!currentMicroAction) return;
      $('#acceptBtn').disabled = true;
      $('#acceptBtn').textContent = '...';
      const res = await api('/api/accept_micro', 'POST', { action_title: currentMicroAction.title });
      render(res.state);
      hideAftercare();
      $('#acceptBtn').disabled = false;
      $('#acceptBtn').textContent = 'Do it';
    };
    
    $('#declineBtn').onclick = hideAftercare;
    
    function openModal(taskName) {
      currentTask = taskName;
      $('#modalTask').textContent = taskName;
      $('#noteInput').value = '';
      $('#modal').classList.add('show');
      $('#noteInput').focus();
    }
    
    function closeModal() {
      $('#modal').classList.remove('show');
      currentTask = null;
    }
    
    $('#cancelBtn').onclick = closeModal;
    $('#modal').onclick = (e) => { if (e.target === $('#modal')) closeModal(); };
    
    $('#confirmBtn').onclick = async () => {
      if (!currentTask) return;
      $('#confirmBtn').disabled = true;
      $('#confirmBtn').textContent = '...';
      
      const res = await api('/api/complete', 'POST', { task_text: currentTask, note: $('#noteInput').value });
      closeModal();
      render(res.state);
      showAftercare(res);
      
      $('#confirmBtn').disabled = false;
      $('#confirmBtn').textContent = 'Complete';
    };
    
    function openParkingModal(taskName) {
      currentParkingTask = taskName;
      $('#parkingModalTask').textContent = taskName;
      $('#parkingNoteInput').value = '';
      $('#parkingModal').classList.add('show');
      $('#parkingNoteInput').focus();
    }
    
    function closeParkingModal() {
      $('#parkingModal').classList.remove('show');
      currentParkingTask = null;
    }
    
    $('#parkingCancelBtn').onclick = closeParkingModal;
    $('#parkingModal').onclick = (e) => { if (e.target === $('#parkingModal')) closeParkingModal(); };
    
    $('#parkingConfirmBtn').onclick = async () => {
      if (!currentParkingTask) return;
      $('#parkingConfirmBtn').disabled = true;
      $('#parkingConfirmBtn').textContent = '...';
      
      const res = await api('/api/complete_parking', 'POST', { 
        task_name: currentParkingTask, 
        note: $('#parkingNoteInput').value 
      });
      closeParkingModal();
      render(res.state);
      showAftercare(res);
      
      $('#parkingConfirmBtn').disabled = false;
      $('#parkingConfirmBtn').textContent = 'Complete';
    };
    
    $('#replanBtn').onclick = async () => {
      const text = $('#input').value.trim();
      if (!text) return;
      
      $('#replanBtn').disabled = true;
      $('#replanBtn').textContent = 'Processing...';
      
      const res = await api('/api/capture', 'POST', { text });
      render(res.state);
      $('#input').value = '';
      
      if (res.confirm_all && res.pending_confirm && res.pending_confirm.length > 0) {
        showClearAllBox(res.pending_confirm, res.pending_parking);
      } else if (res.pending_confirm && res.pending_confirm.length > 0) {
        showConfirmBox(res.pending_confirm);
      } else if (res.praise) {
        $('#aftercarePraise').textContent = res.praise;
        $('#aftercareSafety').textContent = '';
        $('#aftercareHint').style.display = 'none';
        $('#recommendBox').style.display = 'none';
        $('#microSection').style.display = 'none';
        $('#aftercare').classList.add('show');
        setTimeout(hideAftercare, 3000);
      }
      
      $('#replanBtn').disabled = false;
      $('#replanBtn').textContent = 'Replan';
    };
    
    $('#doneToggle').onclick = () => {
      const list = $('#doneList');
      const arrow = $('#doneToggle span');
      list.classList.toggle('show');
      arrow.textContent = list.classList.contains('show') ? '‚ñº' : '‚ñ∂';
    };
    
    (async () => {
      const state = await api('/api/state');
      render(state);
      if (state.praise_style) updateStyleUI(state.praise_style);
    })();
  </script>
</body>
</html>
